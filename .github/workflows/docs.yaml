name: Docs

on:
  push:
    branches: [ main ]
    paths:
      - "app/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "justfile"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: pages-docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@v2

      - run: |
          sudo apt-get update
          sudo apt-get install -y just

      - run: just doc

      - uses: actions/checkout@v6
        with:
          repository: your-org/common-docs
          token: ${{ secrets.DOCS_PUSH_TOKEN }}
          path: common-docs

      - run: |
          rsync -a --delete target/doc/ common-docs/

      - working-directory: common-docs
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Update docs from ${GITHUB_SHA}"
            git push origin HEAD:main
          fi
