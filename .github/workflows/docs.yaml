name: Docs

on:
  push:
    branches: [ main ]
    paths:
      - "app/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "justfile"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: pages-docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@v2

      - run: |
          sudo apt-get update
          sudo apt-get install -y just

      - run: just doc

      - uses: actions/checkout@v6
        with:
          repository: unitn-ap-2025/common-docs
          token: ${{ secrets.DOCS_PUSH_TOKEN }}
          path: common-docs
          persist-credentials: false

      - working-directory: common-docs
        run: |
          mkdir -p docs
          rsync -a --delete ../target/doc/ docs/

      - working-directory: common-docs
        env:
          DOCS_PUSH_TOKEN: ${{ secrets.DOCS_PUSH_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${DOCS_PUSH_TOKEN}@github.com/unitn-ap-2025/common-docs.git
          git fetch origin main || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            if git show-ref --verify --quiet refs/heads/main; then
              git checkout main
            else
              git checkout -b main
            fi
            git reset --hard origin/main
          else
            if git show-ref --verify --quiet refs/heads/main; then
              git checkout main
            else
              git checkout -b main
            fi
          fi
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update docs from ${GITHUB_SHA}"
            git push origin main
          fi
